{% extends 'parent_template.html' %}
{% block title %}Calendar.{% endblock %}

{% block content %}
  <h1>Calendar</h1>
  <div class="calendar" id="calendar"></div>

  <dialog id="scheduleDialog">
    <div class="dialog-container">
      <div class="schedule-list">
        <h2>Existing Schedule</h2>
        <ul id="existingScheduleList"></ul>
      </div>
      <div class="add-schedule">
        <h2>Add Schedule</h2>
        <textarea id="scheduleInput" rows="5" cols="30"></textarea>
        <button onclick="saveSchedule()">Save</button>
        <button onclick="closeDialog()">Cancel</button>
      </div>
    </div>
  </dialog>

  <button onclick="previousMonth()">Previous Month</button>
  <button onclick="nextMonth()">Next Month</button>
  <button onclick="nextNMonths(3)">Next 3 Months</button>
  <button onclick="goToToday()">Go to Today</button>

  <script>
    let currentYear, currentMonth;

    // 获取当前日期
    const currentDate = new Date();
    currentYear = currentDate.getFullYear();
    currentMonth = currentDate.getMonth();

    // 获取本地存储的日程内容
    function getSchedule(date) {
      const scheduleKey = `schedule_${date.getFullYear()}_${date.getMonth()}_${date.getDate()}`;
      return localStorage.getItem(scheduleKey) || '';
    }

    // 保存日程内容到本地存储
    function saveSchedule(date, schedule) {
      const scheduleKey = `schedule_${date.getFullYear()}_${date.getMonth()}_${date.getDate()}`;
      localStorage.setItem(scheduleKey, schedule);
    }

    // 生成日历
    function generateCalendar(year, month) {
      const calendarElement = document.getElementById('calendar');
      calendarElement.innerHTML = '';

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const firstDayIndex = new Date(year, month, 1).getDay();

      // 生成日历头部
      const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      for (let i = 0; i < daysOfWeek.length; i++) {
        const dayElement = document.createElement('div');
        dayElement.classList.add('day');
        dayElement.textContent = daysOfWeek[i];
        calendarElement.appendChild(dayElement);
      }

      // 生成空白日期
      for (let i = 0; i < firstDayIndex; i++) {
        const dayElement = document.createElement('div');
        dayElement.classList.add('day');
        calendarElement.appendChild(dayElement);
      }

      // 生成日期
      for (let i = 1; i <= daysInMonth; i++) {
        const dayElement = document.createElement('div');
        dayElement.classList.add('day');
        dayElement.textContent = i;

        // 添加点击事件
        dayElement.addEventListener('click', function() {
          const schedule = getSchedule(new Date(year, month, i));
          openDialog(new Date(year, month, i), schedule);
        });

        // 高亮当前日期
        if (year === currentYear && month === currentMonth && i === currentDate.getDate()) {
          dayElement.style.backgroundColor = 'lightblue';
        }

        calendarElement.appendChild(dayElement);
      }
    }

    // 打开对话框
    function openDialog(date, schedule) {
      const dialog = document.getElementById('scheduleDialog');
      const existingScheduleList = document.getElementById('existingScheduleList');
      const scheduleInput = document.getElementById('scheduleInput');

      // 清空对话框内容
      existingScheduleList.innerHTML = '';
      scheduleInput.value = '';

      // 显示已有的日程
      if (schedule) {
        const scheduleItems = schedule.split('\n');
        scheduleItems.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item;
          existingScheduleList.appendChild(li);
        });
      }

      // 设置日期和日程内容
      scheduleInput.dataset.date = date.toISOString();
      scheduleInput.value = schedule;

      dialog.showModal();
    }

    // 保存日程
    function saveSchedule() {
      const scheduleInput = document.getElementById('scheduleInput');
      const date = new Date(scheduleInput.dataset.date);
      const schedule = scheduleInput.value;
      saveSchedule(date, schedule);
      closeDialog();
    }

    // 关闭对话框
    function closeDialog() {
      const dialog = document.getElementById('scheduleDialog');
      dialog.close();
    }

    // 前一个月
    function previousMonth() {
      if (currentMonth === 0) {
        currentYear--;
        currentMonth = 11;
      } else {
        currentMonth--;
      }
      generateCalendar(currentYear, currentMonth);
    }

    // 后一个月
    function nextMonth() {
      if (currentMonth === 11) {
        currentYear++;
        currentMonth = 0;
      } else {
        currentMonth++;
      }
      generateCalendar(currentYear, currentMonth);
    }

    // 向后导航 n 个月
    function nextNMonths(n) {
      currentMonth += n;
      if (currentMonth >= 12) {
        const yearsToAdd = Math.floor(currentMonth / 12);
        currentYear += yearsToAdd;
        currentMonth = currentMonth % 12;
      }
      generateCalendar(currentYear, currentMonth);
    }

    // 回到今天
    function goToToday() {
      currentYear = currentDate.getFullYear();
      currentMonth = currentDate.getMonth();
      generateCalendar(currentYear, currentMonth);
    }

    // 初始化日历
    generateCalendar(currentYear, currentMonth);
  </script>


{% endblock %}